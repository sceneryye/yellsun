// Generated by CoffeeScript 1.7.1
(function() {
    window.compute_payment = null;

    $(function() {
        window.compute_payment = function() {
            var bcom_discount, bcom_discount_amount, coupon_amount, coupon_total, order_amount, part_amount, pay_amount, pmt_amount, pmt_total;
            pmt_total = 0.0;
            $(".promotions .pmt").each(function() {
                return pmt_total += parseFloat($(this).data("amount") || 0);
            });
            coupon_total = 0.0;
            coupon_total = parseFloat($("#matched_coupons").attr("data-amount")) || 0;
            pmt_amount = pmt_total + coupon_total;
            $("#pmt_amount").text(-pmt_amount).attr("data-amount", pmt_amount);
            order_amount = parseFloat($("#order_amount").data("amount")) || 0;

            coupon_amount = parseFloat($("#coupon_amount").data("amount")) || 0;
            part_amount = 0.0;
            if ($("#advance").attr("checked") === "checked") {
                part_amount = parseFloat($("#advance").data("amount"));
            }
            pay_amount = order_amount - coupon_amount - pmt_amount;

            $("#final_amount").text(pay_amount);
            bcom_discount = 1.0;
            if ($("#bcom_payment").attr("checked") === "checked") {
                bcom_discount = 0.95;
                bcom_discount_amount = pay_amount(-pay_amount * bcom_discount);
                $("#bcom_discount").text(-bcom_discount_amount);
            }
            pay_amount = pay_amount * bcom_discount - part_amount;

            return $("#pay_amount").text(pay_amount);

        };
        window.compute_payment2 = function() {
            var bcom_discount, order_total, part_pay, pmts_total, products_total;
            products_total = 0.0;
            products_total = parseFloat($("#products_total").data("amount")) || 0;
            part_pay = 0.0;
            if ($("#advance").attr("checked") === "checked") {
                part_pay = parseFloat($("#advance").data("amount")) || 0;
            }
            pmts_total = 0.0;
            pmts_total = parseFloat($("#pmts_total").data("amount")) || 0;
            order_total = products_total - pmts_total;
            bcom_discount = 0.0;
            if ($("#bcom_payment").attr("checked") === "checked") {
                bcom_discount = order_total - Math.round(order_total * 0.95);
            }

            return $("#final_pay").text(order_total - bcom_discount - part_pay);

        };
        compute_payment();
        $("#order_is_tax").bind("change", function() {
            if ($(this).attr("checked") === "checked") {
                return $(".tax-input").removeClass("hide");
            } else {
                return $(".tax-input").addClass("hide");
            }
        });
        $("#payments input[type='radio']").bind("change", function() {
            if ($("#payments input[type='radio']:checked").val() === "bcom") {
                $("#installment_on").attr("checked", false).change();
                $("div[for='#order_payment_bcom']").removeClass("hide");
            } else {
                if ($("#payments input[type='radio']:checked").val() !== "icbc") {
                    $("#installment_on").attr("checked", false).change();
                }
                $("div[for='#order_payment_bcom']").addClass("hide");
            }
            return compute_payment();
        });
        $("#payment_choices input[type='radio']").bind('change', function() {
            if ($("#payment_choices input[type='radio']:checked").val() === "bcom") {
                $("#installment_on").attr("checked", false).change();
                $("div[for='#order_payment_bcom']").removeClass("hide");
            } else {
                if ($("#payments input[type='radio']:checked").val() !== "icbc") {
                    $("#installment_on").attr("checked", false).change();
                }
                $("div[for='#order_payment_bcom']").addClass("hide");
            }
            return window.compute_payment2();
        });
        $("#order_ship_day").bind("change", function() {
            if ($(this).val() === "special") {
                $("#order_ship_special").removeClass("hide");
                return $("#order_ship_special").focus();
            } else {
                $("#order_ship_special").addClass("hide");
                return $("#order_ship_special").val('');
            }
        });
        $(".datetime").datepicker({
            dateFormat: "yy-mm-dd",
            minDate: +1
        });
        $(document).on("click", '.update-link', function() {
            if ($(this).next("form").length > 0) {
                return false;
            }
            return true;
        });
        $(".addr-list").on("change", "input[type='radio']", function() {
            $(".addr-list .active").removeClass("active").find("form").remove();
            $(this).parent(".radio").addClass("active");
            if ($(this).val() === 'new') {
                $("#addr_form").removeClass("hide");
                return $("#member_addr").val('');
            } else {
                $("#addr_form").addClass("hide");
                return $("#member_addr").val($(this).val());
            }
        });
        $(document).on("focus", ".new-addr input[type='text'], .new-addr select", function() {
            return $(this).nextAll(".help-inline").empty();
        });
        $(".order-holder").on("click", '#change_payment', function() {
            $(".order-holder .payment").remove();
            $(".order-holder #payments").removeClass("hide");
            $(".order-holder #payment_choices").removeClass("hide");
            return false;
        });
        $("#installment_on").change(function() {
            if ($(this).attr("checked") === 'checked') {
                return $("#installment_select").removeClass("hide");
            } else {
                $("#installment_select").addClass("hide");
                return $("#installment_select select").val('');
            }
        });
        $("#advance").change(function() {
            if ($(this).attr("checked") === 'checked') {
                $("#part_amount").text("-" + $("#advance").data("amount"));
            } else {
                $("#part_amount").text('-0');
            }
            compute_payment();
            return compute_payment2();
        });
        $("#coupon_options").change(function() {
            var code;
            code = $(this).val();
            return $("#coupon_code").val(code);
        });
        $("#coupon_code").keydown(function(e) {
            if (e.keyCode === 13) {
                e.stopPropagation();
                return e.preventDefault();
            }
        });
        $("#check_coupon").click(function() {
            var code, codes, url;
            code = $("#coupon_code").val();
            if (code.length === 0) {
                $("#matched_coupon").empty();
                alert("请输入优惠券");
                $("#coupon_code").focus();
            } else {
                codes = [];
                codes.push(code);
                $("#matched_coupons input:hidden").each(function() {
                    var _code;
                    _code = $(this).val();
                    if (codes.indexOf(_code) < 0) {
                        return codes.push(_code);
                    }
                });
                url = $(this).attr("href");
                $.get(url, {
                    codes: codes
                }, function() {
                    return window.compute_payment();
                });
            }
            return false;
        });
        return $("#matched_coupons").on("click", ".close", function() {
            var codes, url;
            if (confirm("确定要删除吗？")) {
                $(this).closest('tr').remove();
                if ($("#matched_coupons tr").length === 1) {
                    $("#matched_coupons").empty().attr("data-amount", 0);
                    window.compute_payment();
                    return false;
                }
                codes = [];
                $("#matched_coupons input:hidden").each(function() {
                    var _code;
                    _code = $(this).val();
                    if (codes.indexOf(_code) < 0) {
                        return codes.push(_code);
                    }
                });
                url = $(this).attr("href");
                $.get(url, {
                    codes: codes
                }, function() {
                    return window.compute_payment();
                });
            }
            return false;
        });
    });

}).call(this);
